var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){jm.device=jm.device||{};var e=jm.device,t=800;jm.ERR.device={FA_INVALIDTYPE:{err:t++,msg:"无效的类型"}},e.consts={SEEK_SET:0,SEEK_CUR:1,SEEK_END:2,RDONLY:0,WRONLY:1,RDWR:2,CREAT:64,EXCL:128,NOCTTY:256,TRUNC:512,APPEND:1024,NONBLOCK:2048,SYNC:4096,FASYNC:8192,DIRECT:16384,LARGEFILE:32768,DIRECTORY:65536,NOFOLLOW:131072,NOATIME:262144,NDELAY:2048}}();var jm=jm||{};"undefined"!=typeof exports&&"undefined"!=typeof module&&(jm=require("jm-ecs")),function(){var e=jm.device||{};e.utils={formatJSON:function(e){return JSON.stringify(e,null,2)},dataViewToHex:function(e,t){var i=e;if(i instanceof Array&&(i=new Uint8Array(i)),t=t||i.byteLength,i instanceof ArrayBuffer?i=new DataView(i):i instanceof Uint8Array&&(i=new DataView(i.buffer,i.byteOffset,t)),!i instanceof DataView)return"";for(var n="",r=0;r<t;r++){var a=i.getUint8(r);0==r?n=a.toString(16):n+=" "+a.toString(16)}return n},dataViewToString:function(e,t){for(var i="",n=0;n<t;n++){var r=e.getInt8(n);i+=String.fromCharCode(r)}return i}}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){jm.device.Calibrate=jm.EventEmitter.extend({_className:"calibrate",ctor:function(){this._super()},init:function(e,t){var i={};return i.Divider=(e[0].x-e[2].x)*(e[1].y-e[2].y)-(e[1].x-e[2].x)*(e[0].y-e[2].y),0!=i.Divider&&(i.An=(t[0].x-t[2].x)*(e[1].y-e[2].y)-(t[1].x-t[2].x)*(e[0].y-e[2].y),i.Bn=(e[0].x-e[2].x)*(t[1].x-t[2].x)-(t[0].x-t[2].x)*(e[1].x-e[2].x),i.Cn=(e[2].x*t[1].x-e[1].x*t[2].x)*e[0].y+(e[0].x*t[2].x-e[2].x*t[0].x)*e[1].y+(e[1].x*t[0].x-e[0].x*t[1].x)*e[2].y,i.Dn=(t[0].y-t[2].y)*(e[1].y-e[2].y)-(t[1].y-t[2].y)*(e[0].y-e[2].y),i.En=(e[0].x-e[2].x)*(t[1].y-t[2].y)-(t[0].y-t[2].y)*(e[1].x-e[2].x),i.Fn=(e[2].x*t[1].y-e[1].x*t[2].y)*e[0].y+(e[0].x*t[2].y-e[2].x*t[0].y)*e[1].y+(e[1].x*t[0].y-e[0].x*t[1].y)*e[2].y,this.matrix=i,!0)},transform:function(e){var t=this.matrix;if(!t||!t.Divider)return null;var i={};return i.x=(t.An*e.x+t.Bn*e.y+t.Cn)/t.Divider,i.y=(t.Dn*e.x+t.En*e.y+t.Fn)/t.Divider,i}}),jm.device.Calibrate.generateSamplePoints=function(e,t){var i=e,n=t,r=.8*i,a=.8*n,s=.1*i,o=.1*n;return dx1=s-1,dy1=o-1,dx2=dx1+r,dy2=n/2-1,dx3=i/2-1,dy3=dy1+a,[{x:dx1,y:dy1},{x:dx2,y:dy2},{x:dx3,y:dy3}]}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){jm.device.ComponentDevice=jm.Component.extend({_className:"device",ctor:function(e,t){this._super(e,t)}})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){var e=jm.getLogger("jm-device:serialPort"),t=jm.device,i=t.utils;jm.Uart||(jm.Uart=jm.EventEmitter.extend({_className:"Uart",ctor:function(e){this._super(e)},open:function(e,t,i){return!0},close:function(){},read:function(e,t){return 0},write:function(e,t){return t}})),jm.device.SerialPort=jm.EventEmitter.extend({_className:"SerialPort",ctor:function(e){this._super(e),jm.Uart&&(this.uart=new jm.Uart)},open:function(t,i){if(!this.uart)return!1;var n=9600,r=0,a=128,s=100;i&&(i.baudRate&&(n=i.baudRate),i.config&&(r=i.config),i.bufferLen&&(a=i.bufferLen),i.interval&&(s=i.interval)),this.portName=t,this.opts=i;var o=this.uart;if(o.open(t,n,r)){var c=new ArrayBuffer(a);return this.readBuffer=c,this.readDataView=new DataView(c),this.emit("open"),e.debug(this.portName+" opened"),!0}return!1},close:function(){if(this.uart){var t=this.uart;t.close(),this.emit("close"),e.debug(this.portName+" closed")}},write:function(t,n){if(!this.uart)return 0;var r=this.uart,a=t;if(a instanceof Array&&(a=new Uint8Array(a)),n=n||a.byteLength,n<=0)return 0;if(a instanceof ArrayBuffer?a=new DataView(a):a instanceof Uint8Array&&(a=new DataView(a.buffer,a.byteOffset,n)),!a instanceof DataView)return 0;var s=r.write(a,n);if(jm.debug){var o=this.portName+" sended: len:"+s+" hex:[";o+=i.dataViewToHex(a,n),o+="]",e.debug(o)}return s},update:function(){if(this.uart){var t=this.uart,n=this.readDataView,r=t.read(n,this.readBuffer.byteLength);if(r>0&&(this.emit("data",n,r),jm.debug)){var a=this.portName+" recevied: len:"+r+" hex:[";a+=i.dataViewToHex(n,r),a+="]",e.debug(a)}}}});var n={DATABIT7:1,DATABIT8:0,STOPBIT1:0,STOPBIT2:2,PARITYNONE:0,PARITYODD:12,PARITYEVEN:8};for(var r in n){var a=jm.device.SerialPort.prototype;a[r]=n[r]}jm.device.ComponentSerialPort=jm.device.ComponentDevice.extend({_className:"serialPort",_singleton:!1,ctor:function(e,t){this.serialPort=new jm.device.SerialPort,this._super(e,t),t.autoOpen&&this.serialPort.open(t.portName,t.params)},onAdd:function(e){this._super(e);var t=this;e.on("add",function(i){t.serialPort.on("data",function(t,i){e.emit("data",t,i)}),i.on("exit",function(e){t.serialPort.close()})})},update:function(){this.serialPort.update()},read:function(e,t){return this.serialPort.read(e,t)},write:function(e,t){return this.serialPort.write(e,t)}})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){jm.device.ComponentIOAdapter=jm.device.ComponentDevice.extend({_className:"ioAdapter",_singleton:!1,properties:{ioSize:{get:"getIOSize",set:"setIOSize"},memSize:{get:"getMemSize",set:"setMemSize"},ioPos:{get:"getIOPos"},memPos:{get:"getMemPos"}},ctor:function(e,t){this._super(e,t)},getIOSize:function(){return this._ioSize||0},setIOSize:function(e){this._ioSize=e,this._ioPos=0,this._ioBuffer=new Uint8Array(e);for(var t=this._ioBuffer,i=0;i<t.length;i++)t[i]=255},getMemSize:function(){return this._memSize||0},setMemSize:function(e){this._memSize=e,this._memPos=0},getIOPos:function(){return this._ioPos||0},getMemPos:function(){return this._memPos||0},start:function(){},stop:function(){},io_flush:function(e){},io_update:function(e){},io_seek:function(e,t){var i=this.ioPos;return i=this._seek(i,this.ioSize,e,t),this._ioPos=i,i},io_read:function(e){var t=this.ioPos,i=this._read(this._ioBuffer,t,e);return i?(this.io_seek(i.byteLength,1),i):null},io_write:function(e,t){var i=this.ioPos,n=this._write(this._ioBuffer,i,e,t);return this.io_seek(n,1),n},mem_seek:function(e,t){var i=this.memPos;return i=this._seek(i,this.memSize,e,t),this._memPos=i,i},mem_read:function(e){if(!this._memBuffer)return null;var t=this.memPos,i=(this.memSize,this._read(this._memBuffer,t,e));return i?(this.mem_seek(i.byteLength,1),i):null},mem_write:function(e,t){if(!this._memBuffer)return 0;var i=this.memPos,n=this._write(this._memBuffer,i,e,t);return this.mem_seek(n,1),n},_seek:function(e,t,i,n){switch(void 0==i&&(i=0),void 0==n&&(n=1),n){case 0:e=i;break;case 1:e+=i;break;case 2:e=t-1+i}return(e<-1||e>=t)&&(e=-1),e},_read:function(e,t,i){if(void 0==i&&(i=e.byteLength),i<=0||t==-1)return null;var n=e.byteLength,r=i,a=n-t;return r>a&&(r=a),r<=0?null:e.subarray(t,t+r)},_write:function(e,t,i,n){if(void 0==n&&(n=i.byteLength),n<=0||t==-1)return 0;var r=e.byteLength,a=n,s=r-t;return a>s&&(a=s),a<=i.byteLength&&(i=i.subarray(0,a)),e.set(i,t),a}});var e={SEEK_SET:0,SEEK_CUR:1,SEEK_END:2};for(var t in e){var i=jm.device.ComponentIOAdapter.prototype;i[t]=e[t]}}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){var e=jm.getLogger("jm-device:touchDevice");jm.device.ComponentTouchDevice=jm.device.ComponentIOAdapter.extend({_className:"touchDevice",_singleton:!1,_nameReadOnly:!0,properties:{calibrated:{get:"getCalibrated"},config:{get:"getConfig",set:"setConfig"},touchInfo:{get:"getTouchInfo",set:"setTouchInfo"}},getCalibrated:function(){return this._calibrated},getConfig:function(){return this._config||{}},setConfig:function(e){return this._config=e,e?void(e.source&&e.target&&(this._calibrated=this.calibrate.init(e.source,e.target))):void(this._calibrated=!1)},getConfigPath:function(){if(!cc.sys.isNative)return null;var e=jsb.fileUtils,t=e.getWritablePath();return t+="/touch.plist"},loadConfig:function(){},saveConfig:function(){},setTouchInfo:function(t){if(this._touchInfo=t,this.calibrated){var i=t.id,n=t.x,r=t.y,a=this.transform(t);if(a&&(n=a.x,r=a.y),cc&&cc.eventManager){var s=0;switch(t.status){case 2:s=1;break;case 4:s=2}cc.sys.isNative&&(cc.configuration.setValue("event_jm_touch",s+", "+i+","+n+","+r),cc.eventManager.dispatchCustomEvent("event_jm_touch"),jm.debug&&jm.debug("dispatchCustomEvent: x:"+n+" y:"+r))}}this.entity&&(jm.debug&&e.debug("touchInfo: x:"+t.x+" y:"+t.y),this.entity.emit("touch",t))},getTouchInfo:function(){return this._touchInfo||{}},transform:function(e){return this._calibrated?this.calibrate.transform(e):null},ctor:function(e,t){t=t||{},t.ioSize=8,t.memSize=16,t.DIAddress=0,this._super(e,t),this._name="touchDevice",this._calibrated=!1,this.calibrate=new jm.device.Calibrate,this.loadConfig()}})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){var e=jm.getLogger("jm-device:touchDeviceHC"),t=jm.device,i=t.utils;jm.device.ComponentTouchDeviceHC=jm.device.ComponentTouchDevice.extend({_className:"touchDeviceHC",PACKETHEAD1:85,PACKETHEAD2:84,MAXPACKETLEN:128,properties:{type:{get:"getType",set:"setType"},dataLen:{get:"getDataLen"},endLen:{get:"getEndLen"}},getType:function(){return this._type||0},setType:function(e){this._type=e,this._dataLen=0==e?5:11,this._endLen=0==e?3:0},getDataLen:function(){return void 0==this._dataLen?5:this._dataLen},getEndLen:function(){return void 0==this._endLen?3:this._endLen},ctor:function(e,t){this._super(e,t),this._data=new Uint8Array(this.MAXPACKETLEN),this._offset=0,this._step=0},onAdd:function(e){this._super(e);var t=this;e.on("data",function(e,i){i=i||e.byteLength,i>0&&t.onData(e,i)})},calcCrc:function(e,t){if(t=t||e.byteLength,t<=0)return 0;for(var i=0,n=0;n<t;n++)i+=e[n],i&=255;return i-=174,i&=255},validPacket:function(t,n){n=n||t.byteLength;var r=!0;switch(this.type){case 1:r=this.validPacket1(t,n);break;default:r=this.validPacket0(t,n)}return r||jm.debug&&e.debug("validPacket fail: "+i.dataViewToHex(t,n)),r},onData:function(e,t){var i=this,n=(i.entity,new Uint8Array(e.buffer));t=t||e.byteLength;for(var r=this.dataLen,a=this.endLen,s=this._data,o=this._offset,c=this._step,u=0;u<t;u++){var f=n[u];0==c&&f==i.PACKETHEAD1?c++:1==c&&f==i.PACKETHEAD2?(c++,o=0):2==c?(s[o++]=f,o==r+a&&(this.validPacket(s,o)&&this.onPacket(s,r),c=0,o=0)):(c=0,o=0)}this._offset=o,this._step=c},validPacket0:function(e,t){var i=e[t-1];return this.calcCrc(e,t-3)==i},validPacket1:function(e,t){return!0},onPacket:function(t,n){switch(jm.debug&&e.debug("onPacket:"+i.dataViewToHex(t,n)),this.type){case 1:break;default:var r=new DataView(t.buffer,0,n),a={id:0,status:15&t[0],x:r.getUint16(1,!0),y:r.getUint16(3,!0),z:0};this.touchInfo=a}}})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){var e=jm.getLogger("jm-device:hopper"),t=jm.device,i=t.utils;jm.device.ComponentHopper=jm.device.ComponentDevice.extend({_className:"hopper",_singleton:!1,PACKETHEAD1:5,PACKETHEAD2:1,MAXPACKETLEN:12,statusDict:{1:"Motor problem",2:"Insufficient Coins",8:"Reserve",16:"Prism Sensor Failure",32:"Shaft Sensor Failure",128:"Dispenser is busy"},properties:{remainCoins:{get:"getRemainCoins"}},ctor:function(e,t){this._super(e,t),this._enable=!0,this.machineId=t.machineId||3,this.buf=[5,16,this.machineId,0,0,0],this._data=new Uint8Array(this.MAXPACKETLEN),this._offset=0,this._step=0,this._packetLen=6},onAdd:function(e){this._super(e);var t=this;e.on("add",function(e){t.reset()}),e.on("data",function(e,i){i>0&&t.onData(e,i)})},validPacket:function(t,n){var r=!0;return t[2]==this.machineId&&this.checkCrc(t)||(r=!1),r||e.debug("validPacket fail: "+i.dataViewToHex(t,n)),r},onPacket:function(e,t){var i=this,n=i.entity,r=e[3],a=e[4];switch(i.cmd=r,n.emit("cmd",r),r){case 4:var s=a;i.status=s,n.emit("status",s);break;case 7:n.emit("payOutOne");break;case 8:n.emit("payOutFin");break;case 9:n.emit("clear");break;case 170:this._remainCoins=a;break;case 187:n.emit("payOutBusy")}},onData:function(e,t){var i=this,n=new Uint8Array(e.buffer);t=t||e.byteLength;for(var r=this._packetLen,a=this._data,s=this._offset,o=this._step,c=0;c<t;c++){var u=n[c];0==o&&u==i.PACKETHEAD1?o++:1==o&&u==i.PACKETHEAD2?(o++,a[s++]=i.PACKETHEAD1,a[s++]=i.PACKETHEAD2):2==o?(a[s++]=u,s==r&&(this.validPacket(a,s)&&this.onPacket(a,r),o=0,s=0)):(o=0,s=0)}this._offset=s,this._step=o},reset:function(){this.send([18,0])},getStatus:function(){this.send([17,0])},payOut:function(e,t){t?this.send([20,e]):this.send([16,e])},readRemainCoins:function(){this.send([19,0])},getRemainCoins:function(){return this._remainCoins||0},calcCrc:function(e){for(var t=0,i=6,n=0;n<i-1;n++)t+=e[n];return e[i-1]=t,t},checkCrc:function(e){var t=6,i=e[t-1],n=this.calcCrc(e);return i==n},send:function(e){for(var t=this.buf,i=0;i<e.length;i++)t[i+3]=e[i];this.calcCrc(t);var n=this.entity,r=n.serialPort.serialPort;return r?r.write(t):0}})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){var e=(jm.getLogger("jm-device:receiptPrinter"),jm.device);e.utils;jm.device.ComponentReceiptPrinter=jm.device.ComponentDevice.extend({_className:"receiptPrinter",_singleton:!1,ctor:function(e,t){this.noPaper=!1,this._super(e,t)},onAdd:function(e){this._super(e);e.on("data",function(t,i){for(var n=0;n<i;n++){var r=t.getInt8(n),a=r>=1;this.noPaper!=a&&(this.noPaper=a,e.emit("status",a))}})},reset:function(){var e=new Uint8Array([27,64]);this.print(e)},getStatus:function(){var e=new Uint8Array([16,4,4]);this.print(e)},print:function(e,t){var i=this.entity,n=i.serialPort.serialPort;return n?n.write(e,t):0},cut:function(e){var t=new Uint8Array([27,105]);e&&(t=new Uint8Array([27,109])),this.print(t)},zouzhi:function(e){e=e||30;var t=new Uint8Array([27,74,e]);this.print(t)},setAlign:function(e){e=e||0;var t=new Uint8Array([27,97,e]);this.print(t)},setLineSpace:function(e){e=e||0;var t=new Uint8Array([27,50]);e&&(t=new Uint8Array([27,51,e])),this.print(t)},setPosition:function(e,t){e=e||0,t=t||0;var i=new Uint8Array([27,36,e,t]);this.print(i)},setFontSize:function(e){var t=27,i=0;e.scaleHeight&&(i|=32),e.scaleWidth&&(i|=16),e.hanzi&&(i=0,t=28,e.scaleHeight&&(i|=8),e.scaleWidth&&(i|=4));var n=new ArrayBuffer(4),r=new DataView(n);r.setInt8(0,t,!1),r.setInt8(1,33,!1),r.setInt8(2,i,!1);var a=3;this.print(r,a)},setHanziFontSize:function(e,t){var i={hanzi:!0,scaleWidth:e,scaleHeight:t};this.setFontSize(i)},setXiwenFontSize:function(e,t){var i={hanzi:!1,scaleWidth:e,scaleHeight:t};this.setFontSize(i)}})}();var jm=jm||{};"undefined"!=typeof module&&module.exports&&(jm=require("jm-ecs")),function(){var e=jm.getLogger("jm-device:billAcceptor"),t=jm.device;t.utils;jm.device.ComponentBillAcceptor=jm.device.ComponentDevice.extend({_className:"billAcceptor",_singleton:!1,statusDict:{62:"Bill Acceptor enable",94:"Bill Acceptor disable",113:"Bill Acceptor busy",128:"Bill Acceptor reset",129:"Bill type",161:"Power Supply On communication",16:"Bill accept finished",17:"Bill accept failed",32:"Motor failure",33:"Checksum error",34:"Bill jam",35:"Bill remove",36:"Stacker open",37:"Sensor problem",38:"Communication failed",39:"Bill fish",40:"Stacker problem",41:"Bill reject",42:"Invalid command",46:" Reserved",47:"Exception has been recovered"},billDict:{0:1,1:5,2:10,3:20,4:50,5:100},properties:{enable:{get:"getEnable",set:"setEnable"}},ctor:function(e,t){this._super(e,t),this._enable=!0},onAdd:function(e){this._super(e);var t=this;e.on("add",function(e){t.reset()}),e.on("data",function(e,i){i>0&&t.onData(e,i)})},onData:function(t,i){var n=this,r=n.entity,a=new Uint8Array(t.buffer),s=a[0];switch(n.status=s,r.emit("status",s,n.statusDict[s]),a[0]){case 128:2==i&&143==a[1]&&(e.debug("billAcceptor request reset."),this.accept());break;case 129:if(3==i&&143==a[1]){var o=a[2]-64;n.bill=o;var c=o,u=n.billDict[c];r.emit("escrow",c,u),e.debug("billAcceptor request escrow "+c+" "+u),n.noEscrow&&n.accept()}break;case 16:var c=n.bill,u=n.billDict[c];r.emit("bill",c,u),e.debug("billAcceptor accept bill "+c+" "+u);break;case 17:e.debug("billAcceptor accept bill failed "+n.bill);break;case 62:this._enable=!0;break;case 94:this._enable=!1}},reset:function(){this.send([48])},getStatus:function(){this.send([12])},accept:function(){this.send([2])},reject:function(){this.send([15])},holdAt:function(){this.send([24])},getEnable:function(){return this._enable},setEnable:function(e){e?this.send([62]):this.send([94])},send:function(e,t){var i=this.entity,n=i.serialPort.serialPort;return n?n.write(e,t):0}})}();